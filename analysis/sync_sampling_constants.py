#!/usr/bin/env python
"""
Sync sampling model constants from analysis output to config.py.

This script reads the fitted model parameters from sampling_model_constants.json
(generated by sampling_analysis.py) and updates the constants in config.py.

Usage:
    python analysis/sync_sampling_constants.py
"""

import json
import re
from pathlib import Path

# Paths
SCRIPT_DIR = Path(__file__).parent
CONSTANTS_FILE = SCRIPT_DIR / "output" / "sampling_model_constants.json"
CONFIG_FILE = SCRIPT_DIR.parent / "pysrc" / "cityseer" / "config.py"


def main():
    # Load the model constants
    if not CONSTANTS_FILE.exists():
        print(f"Note: Constants file not found: {CONSTANTS_FILE}")
        print("Run sampling_analysis.py first to generate the model constants.")
        print("Skipping sync (this is not an error).")
        return 0  # Don't fail - just skip if file doesn't exist

    with open(CONSTANTS_FILE) as f:
        constants = json.load(f)

    print(f"Loaded constants from: {CONSTANTS_FILE}")
    print(f"  Generated: {constants['generated']}")
    print(f"  Data points: {constants['data_points']}")

    # Extract values
    rho_a = constants["rho_model"]["A"]
    rho_b = constants["rho_model"]["B"]
    std_c = constants["std_model"]["C"]
    std_d = constants["std_model"]["D"]
    bias_e = constants.get("bias_model", {}).get("E", 0.46)
    bias_f = constants.get("bias_model", {}).get("F", -0.13)

    print("\nModel parameters:")
    print(f"  Rho: A={rho_a}, B={rho_b}")
    print(f"  Std: C={std_c}, D={std_d}")
    print(f"  Bias: E={bias_e}, F={bias_f}")

    # Read config.py
    config_content = CONFIG_FILE.read_text()

    # Define patterns and replacements
    updates = [
        ("SAMPLING_MODEL_RHO_A", rho_a),
        ("SAMPLING_MODEL_RHO_B", rho_b),
        ("SAMPLING_MODEL_STD_C", std_c),
        ("SAMPLING_MODEL_STD_D", std_d),
        ("SAMPLING_MODEL_BIAS_E", bias_e),
        ("SAMPLING_MODEL_BIAS_F", bias_f),
    ]

    updated = False
    for var_name, new_value in updates:
        # Pattern to match the variable assignment (handles negative numbers)
        pattern = rf"^({var_name}: float = )-?[\d.]+(.*)$"
        replacement = rf"\g<1>{new_value}\2"

        new_content, count = re.subn(pattern, replacement, config_content, flags=re.MULTILINE)
        if count > 0:
            config_content = new_content
            updated = True
            print(f"  Updated {var_name} = {new_value}")
        else:
            print(f"  Warning: Could not find {var_name} in config.py")

    if updated:
        CONFIG_FILE.write_text(config_content)
        print(f"\nUpdated: {CONFIG_FILE}")
    else:
        print("\nNo updates made.")

    return 0


if __name__ == "__main__":
    exit(main())
